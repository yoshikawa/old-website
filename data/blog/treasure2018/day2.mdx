---
title: 'Treasure2018 2æ—¥ç›® Golang'
date: '2018-08-14'
draft: false
images: ['/static/images/treasure/all.jpg']
tags: ['internship', 'treasure']
---

#### å‰å›ã®è¨˜äº‹

[Treasure2018 1 æ—¥ç›®](https://yoshikawa.dev/blog/treasure2018/day1)

## Treasure2018 2 æ—¥ç›®

ä»Šæ—¥ã¯ Golang å…¥é–€ 2 æ—¥ç›®

### ã‚„ã£ãŸã“ã¨

ç°¡å˜ãª Web ã‚¢ãƒ—ãƒªã‚’ Golang ã§æ›¸ã‘ã‚‹ã“ã¨ãŒå‡ºæ¥ãŸ ğŸ‰ğŸ‰

TODO ã‚¢ãƒ—ãƒªã®æ‹¡å¼µã€‚

SQL ã¨ Golang ã‚’ç¹‹ã’ã‚‹ä½œæ¥­ã€‚

SQL ã‚’å©ã„ã¦ Golang ã§ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã—ãŸã€‚

### ã‚ã‹ã‚‰ãªã‹ã£ãŸã¨ã“ã‚

æœ€å¾Œã® TODO ã‚¢ãƒ—ãƒªã®æ¤œç´¢ã®ä»•æ–¹ã§æ‰‹é–“å–ã‚Šã¾ã—ãŸã€‚

title ã¨ status ã§æ¤œç´¢ã—ãŸã‹ã£ãŸã‘ã©ã€ç‰‡æ–¹ã ã‘ã®æ¤œç´¢ã—ã‹å‡ºæ¥ãªã‹ã£ãŸã€‚

**title ã¨ status ã®åŒæ™‚æ¤œç´¢ãŒå‡ºæ¥ãªã‹ã£ãŸã€‚**

```shell
curl http://localhost:8080/api/todos/search?title=test\&completed=0
```

`controller/task.go`ãƒ•ã‚¡ã‚¤ãƒ«

```go
package controller

import (
	"encoding/json"
	"net/http"

	"github.com/voyagegroup/go-todo/model"

	"github.com/jmoiron/sqlx"
)

// Todo ã¯Todoã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢ã™ã‚‹åˆ¶å¾¡ã‚’ã—ã¾ã™
type Todo struct {
	DB *sqlx.DB
}

// Getã¯DBã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ã‚’å–å¾—ã—ã¦çµæœã‚’è¿”ã—ã¾ã™
func (t *Todo) Get(w http.ResponseWriter, r *http.Request) error {
	todos, err := model.TodosAll(t.DB)
	if err != nil {
		return err
	}
	return JSON(w, 200, todos)
}

func (t *Todo) Put(w http.ResponseWriter, r *http.Request) error {
	var todo model.Todo
	if err := json.NewDecoder(r.Body).Decode(&todo); err != nil {
		return err
	}

	if err := TXHandler(t.DB, func(tx *sqlx.Tx) error {
		result, err := todo.Update(tx)
		if err != nil {
			return err
		}
		if err := tx.Commit(); err != nil {
			return err
		}
		todo.ID, err = result.LastInsertId()
		return err
	}); err != nil {
		return err
	}

	return JSON(w, http.StatusOK, todo)
}

// Postã¯ã‚¿ã‚¹ã‚¯ã‚’DBã«è¿½åŠ ã—ã¾ã™
// todoã‚’JSONã¨ã—ã¦å—ã‘å–ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
func (t *Todo) Post(w http.ResponseWriter, r *http.Request) error {
	var todo model.Todo
	if err := json.NewDecoder(r.Body).Decode(&todo); err != nil {
		return err
	}

	if err := TXHandler(t.DB, func(tx *sqlx.Tx) error {
		result, err := todo.Insert(tx)
		if err != nil {
			return err
		}
		if err := tx.Commit(); err != nil {
			return err
		}
		todo.ID, err = result.LastInsertId()
		return err
	}); err != nil {
		return err
	}

	return JSON(w, http.StatusCreated, todo)
}

func (t *Todo) Delete(w http.ResponseWriter, r *http.Request) error {
	var todo model.Todo
	if err := json.NewDecoder(r.Body).Decode(&todo); err != nil {
		return err
	}

	if err := TXHandler(t.DB, func(tx *sqlx.Tx) error {
		_, err := todo.Delete(tx)
		if err != nil {
			return err
		}
		return tx.Commit()
	}); err != nil {
		return err
	}

	return JSON(w, http.StatusOK, todo)
}

func (t *Todo) Toggle(w http.ResponseWriter, r *http.Request) error {
	var todo model.Todo

	if err := json.NewDecoder(r.Body).Decode(&todo); err != nil {
		return err
	}

	if err := TXHandler(t.DB, func(tx *sqlx.Tx) error {
		_, err := todo.Toggle(tx)
		if err != nil {
			return err
		}
		return tx.Commit()
	}); err != nil {
		return err
	}

	return JSON(w, http.StatusOK, todo)
}

func (t *Todo) Search(w http.ResponseWriter, r *http.Request) error {
	title := r.URL.Query().Get("title")
	completed := r.URL.Query().Get("completed")

	todo, err := model.SearchByCompleted(t.DB, completed)
	if err != nil {
		return err
	}

	return JSON(w, http.StatusOK, todo)
}
```

`model/task.go` ãƒ•ã‚¡ã‚¤ãƒ«

```go
package model

import (
	"database/sql"
	"time"

	"github.com/jmoiron/sqlx"
)

// Todoã¯ç®¡ç†ã™ã‚‹ã‚¿ã‚¹ã‚¯
type Todo struct {
	ID        int64      `db:"todo_id" json:"id"`
	Title     string     `json:"title"`
	Completed bool       `json:"completed"`
	Created   *time.Time `json:"created"`
	Updated   *time.Time `json:"updated"`
}

func TodosAll(dbx *sqlx.DB) (todos []Todo, err error) {
	if err := dbx.Select(&todos, "select * from todos"); err != nil {
		return nil, err
	}
	return todos, nil
}

func TodoOne(dbx *sqlx.DB, id int64) (*Todo, error) {
	var todo Todo
	if err := dbx.Get(&todo, `
	select * from todos where todo_id = ?
	`, id); err != nil {
		return nil, err
	}
	return &todo, nil
}

// TodosToggleAllã¯å…¨éƒ¨ã®toggleã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒˆã‚°ãƒ«ã—ã¾ã™
func TodosToggleAll(tx *sqlx.Tx, checked bool) (sql.Result, error) {
	stmt, err := tx.Prepare(`
	update todos set completed = ?
	`)
	if err != nil {
		return nil, err
	}
	defer stmt.Close()
	return stmt.Exec(checked)
}

func (t *Todo) Update(tx *sqlx.Tx) (sql.Result, error) {
	stmt, err := tx.Prepare(`
	update todos set title = ? where todo_id = ?
	`)
	if err != nil {
		return nil, err
	}
	defer stmt.Close()
	return stmt.Exec(t.Title, t.ID)
}

func (t *Todo) Insert(tx *sqlx.Tx) (sql.Result, error) {
	stmt, err := tx.Prepare(`
	insert into todos (title, completed)
	values(?, ?)
	`)
	if err != nil {
		return nil, err
	}
	defer stmt.Close()
	return stmt.Exec(t.Title, t.Completed)
}

// Toggle ã¯æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ç¾åœ¨ã®çŠ¶æ…‹ã¨å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚
func (t *Todo) Toggle(tx *sqlx.Tx) (sql.Result, error) {
	stmt, err := tx.Prepare(`
	update todos set completed=?
	where todo_id=?
	`)
	if err != nil {
		return nil, err
	}
	defer stmt.Close()
	return stmt.Exec(!t.Completed, t.ID)
}

func (t *Todo) Delete(tx *sqlx.Tx) (sql.Result, error) {
	stmt, err := tx.Prepare(`delete from todos where todo_id = ?`)
	if err != nil {
		return nil, err
	}
	defer stmt.Close()
	return stmt.Exec(t.ID)
}

// TodosDeleteAllã¯ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’æ¶ˆå»ã—ã¾ã™ã€‚
func TodosDeleteAll(tx *sqlx.Tx) (sql.Result, error) {
	stmt, err := tx.Prepare(`delete from todos where completed = 1`)
	if err != nil {
		return nil, err
	}
	defer stmt.Close()
	return stmt.Exec()
}

func SearchByTitle(dbx *sqlx.DB, title string) ([]*Todo, error) {
	var todos []*Todo

	if err := dbx.Select(&todos, "select * from todos where title = ?", title); err != nil {
		return nil, err
	}

	return todos, nil
}

func SearchByCompleted(dbx *sqlx.DB, completed string) ([]*Todo, error) {
	var todos []*Todo

	if err := dbx.Select(&todos, "select * from todos where completed = ?", completed); err != nil {
		return nil, err
	}

	return todos, nil
}
```

`server.go` ã«ä»¥ä¸‹ã‚’è¿½è¨˜

```go
router.Handle("/api/todos/search", handler(todo.Search)).Methods("GET")
```

### memo

SQL ã®ä½¿ã„æ–¹ã¯ä»¥ä¸‹ã® URL ã‚’å‚è€ƒã«ã™ã‚‹ã€‚

[https://github.com/go-sql-driver/mysql/wiki/Examples](https://github.com/go-sql-driver/mysql/wiki/Examples)

[http://go-database-sql.org/accessing.html](http://go-database-sql.org/accessing.html)

[https://github.com/jmoiron/sqlx](https://github.com/jmoiron/sqlx)

[https://github.com/variadico/scaneo](https://github.com/variadico/scaneo)

#### æ¬¡å›ã®è¨˜äº‹

[Treasure2018 3 æ—¥ç›®](https://yoshikawa.dev/blog/treasure2018/day3)
